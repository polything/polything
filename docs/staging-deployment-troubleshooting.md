# Staging Deployment Troubleshooting Guide

**Date**: 2025-01-27  
**Status**: Staging deployment successful with known issues  
**Project**: Polything WordPress to Next.js Migration  

## Overview

This document provides comprehensive troubleshooting information for the staging deployment process, including resolved issues and ongoing challenges with the WordPress content export.

## ‚úÖ Successfully Resolved Issues

### 1. Vercel Configuration Conflicts

**Issue**: `vercel.json` contained conflicting `builds` and `functions` properties
```
Error: The `functions` property cannot be used in conjunction with the `builds` property. Please remove one of them.
```

**Solution**: Updated to modern framework detection approach
```json
{
  "version": 2,
  "framework": "nextjs",
  "buildCommand": "pnpm run build",
  "installCommand": "pnpm install"
}
```

**Files Modified**: `vercel.json`

### 2. Dependency Version Conflicts

**Issue**: `date-fns@4.1.0` incompatible with `react-day-picker@8.10.1`
```
npm error ERESOLVE unable to resolve dependency tree
npm error peer date-fns@"^2.28.0 || ^3.0.0" from react-day-picker@8.10.1
```

**Solution**: Downgraded to compatible version
```json
{
  "date-fns": "^3.6.0"
}
```

**Files Modified**: `package.json`

### 3. Contentlayer Import Errors

**Issue**: Disabled files in app directory causing import errors
```
Module not found: Package path ./generated is not exported from package contentlayer2
```

**Solution**: Moved disabled files out of app directory
```bash
mkdir -p disabled-files
mv app/*.disabled disabled-files/
```

**Files Moved**: 
- `app/[slug].disabled/` ‚Üí `disabled-files/[slug].disabled/`
- `app/blog/[slug].disabled/` ‚Üí `disabled-files/blog/[slug].disabled/`
- `app/work/[slug].disabled/` ‚Üí `disabled-files/work/[slug].disabled/`
- `app/sitemap.ts.disabled` ‚Üí `disabled-files/sitemap.ts.disabled`

### 4. Package Manager Inconsistency

**Issue**: Vercel using npm while project uses pnpm
```
Detected `pnpm-lock.yaml` which may be generated by pnpm@9.x or pnpm@10.x
```

**Solution**: Updated Vercel configuration to use pnpm
```json
{
  "installCommand": "pnpm install",
  "buildCommand": "pnpm run build"
}
```

## ‚ùå Ongoing Critical Issues

### 1. WordPress Content Export Limited to Projects

**Issue**: Export script only successfully exports project case studies
- ‚úÖ **Projects**: 5 case studies exported successfully
- ‚ùå **Posts**: HTTP 404 errors from `/wp-json/wp/v2/posts`
- ‚ùå **Pages**: HTTP 404 errors from `/wp-json/wp/v2/pages`

**Impact**: Only 5 out of 249 total pages migrated (2% completion)

**Investigation Commands**:
```bash
# Test API endpoints
curl -s "https://polything.co.uk/wp-json/wp/v2/posts?per_page=1"
curl -s "https://polything.co.uk/wp-json/wp/v2/pages?per_page=1"
curl -s "https://polything.co.uk/wp-json/wp/v2/project?per_page=1"
```

**Potential Root Causes**:
1. WordPress REST API not enabled for standard content types
2. Authentication required for posts/pages access
3. Plugin dependencies missing (ACF to REST API, etc.)
4. Custom post type registration differences

**Immediate Workarounds**:
1. Manual content creation for critical pages
2. WordPress export tools (WXR format)
3. Direct database queries
4. Plugin installation on WordPress site

### 2. Contentlayer Integration Disabled

**Issue**: Dynamic page generation disabled due to import path issues
- Sitemap generation disabled
- Dynamic routing for projects/posts/pages not functional
- SEO metadata generation limited

**Impact**: Static site only, no dynamic content routing

**Next Steps**:
1. Fix contentlayer2 import paths
2. Restore dynamic page generation
3. Re-enable sitemap generation
4. Implement proper content routing

## üîß Build Process Status

### Current Build Output
```
Route (app)                                 Size  First Load JS    
‚îå ‚óã /                                    4.31 kB         123 kB
‚îú ‚óã /_not-found                            986 B         103 kB
‚îú ‚óã /design-system-demo                  1.88 kB         117 kB
‚îú ‚óã /robots.txt                            127 B         102 kB
‚îî ‚óã /services/marketing-strategy         3.23 kB         117 kB
+ First Load JS shared by all             102 kB
```

### Generated Static Pages
1. **Homepage** (`/`) - Design system showcase
2. **404 Page** (`/_not-found`) - Error handling
3. **Design System Demo** (`/design-system-demo`) - Component library
4. **Robots.txt** (`/robots.txt`) - SEO configuration
5. **Services Page** (`/services/marketing-strategy`) - Static content

### Missing Dynamic Pages
- Project case studies (5 available but not routed)
- Blog posts (0 exported)
- Static pages (0 exported)

## üìä Content Migration Status

### Successfully Exported Content
```
content/project/
‚îú‚îÄ‚îÄ blackriver/
‚îÇ   ‚îî‚îÄ‚îÄ index.mdx (11.4 KB)
‚îú‚îÄ‚îÄ blackriver-ramps-xmas/
‚îÇ   ‚îî‚îÄ‚îÄ index.mdx
‚îú‚îÄ‚îÄ bluefort-security/
‚îÇ   ‚îî‚îÄ‚îÄ index.mdx
‚îú‚îÄ‚îÄ bluefort-security-strategy/
‚îÇ   ‚îî‚îÄ‚îÄ index.mdx
‚îî‚îÄ‚îÄ wolf-the-worlds-online-festival/
    ‚îî‚îÄ‚îÄ index.mdx
```

### Content Quality
- ‚úÖ Proper front-matter structure
- ‚úÖ SEO metadata included
- ‚úÖ Canonical URLs generated
- ‚úÖ Hero fields mapped
- ‚úÖ Content sanitized and converted to MDX

### Export Report Summary
```json
{
  "summary": {
    "total": 5,
    "success": 5,
    "errors": 2,
    "duration": 1935
  }
}
```

## üöÄ Deployment Configuration

### Vercel Settings
- **Framework**: Next.js (auto-detected)
- **Build Command**: `pnpm run build`
- **Install Command**: `pnpm install`
- **Output Directory**: `.next`
- **Node Version**: 18.x

### Security Headers
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

### Media Redirects
```json
{
  "redirects": [
    {
      "source": "/wp-content/uploads/(.*)",
      "destination": "/images/$1",
      "permanent": true
    }
  ]
}
```

## üîç Debugging Commands

### Test WordPress API
```bash
# Check API availability
curl -I "https://polything.co.uk/wp-json/wp/v2/"

# Test specific endpoints
curl -s "https://polything.co.uk/wp-json/wp/v2/posts?per_page=1" | jq '.[0].title'
curl -s "https://polything.co.uk/wp-json/wp/v2/pages?per_page=1" | jq '.[0].title'
curl -s "https://polything.co.uk/wp-json/wp/v2/project?per_page=1" | jq '.[0].title'
```

### Verify Build
```bash
# Local build test
pnpm install
pnpm run build

# Check build output
ls -la .next/static/
```

### Content Validation
```bash
# Check exported content
find content -name "*.mdx" -exec wc -l {} \;
head -20 content/project/blackriver/index.mdx
```

## üìã Next Steps Priority

### High Priority
1. **Investigate WordPress REST API** - Determine why posts/pages endpoints return 404
2. **Implement Alternative Export** - Use WordPress export tools or direct database access
3. **Restore Contentlayer** - Fix import issues for dynamic page generation

### Medium Priority
4. **Complete Content Migration** - Export remaining 244 pages and posts
5. **QA Testing** - Validate migrated content against original WordPress site
6. **Performance Optimization** - Optimize build times and bundle sizes

### Low Priority
7. **SEO Enhancement** - Implement full structured data and sitemap generation
8. **Analytics Integration** - Add Google Analytics and performance monitoring
9. **Error Handling** - Implement comprehensive error boundaries and logging

## üìû Support Resources

### Documentation
- [WordPress REST API Reference](https://developer.wordpress.org/rest-api/reference/)
- [Contentlayer Documentation](https://www.contentlayer.dev/docs/)
- [Next.js App Router Guide](https://nextjs.org/docs/app)
- [Vercel Deployment Guide](https://vercel.com/docs/deployments/overview)

### Project Files
- `scripts/wp-export.mjs` - Main export script
- `config/wordpress.json` - WordPress API configuration
- `vercel.json` - Deployment configuration
- `contentlayer.config.ts` - Content processing configuration

---

**Last Updated**: 2025-01-27  
**Status**: Staging deployment successful, content export partially working  
**Next Review**: After WordPress API investigation
