# Staging Deployment Troubleshooting Guide

**Date**: 2025-01-27  
**Status**: Staging deployment successful with known issues  
**Project**: Polything WordPress to Next.js Migration  

## Overview

This document provides comprehensive troubleshooting information for the staging deployment process, including resolved issues and ongoing challenges with the WordPress content export.

## ✅ Successfully Resolved Issues

### 1. Vercel Configuration Conflicts

**Issue**: `vercel.json` contained conflicting `builds` and `functions` properties
```
Error: The `functions` property cannot be used in conjunction with the `builds` property. Please remove one of them.
```

**Solution**: Updated to modern framework detection approach
```json
{
  "version": 2,
  "framework": "nextjs",
  "buildCommand": "pnpm run build",
  "installCommand": "pnpm install"
}
```

**Files Modified**: `vercel.json`

### 2. Dependency Version Conflicts

**Issue**: `date-fns@4.1.0` incompatible with `react-day-picker@8.10.1`
```
npm error ERESOLVE unable to resolve dependency tree
npm error peer date-fns@"^2.28.0 || ^3.0.0" from react-day-picker@8.10.1
```

**Solution**: Downgraded to compatible version
```json
{
  "date-fns": "^3.6.0"
}
```

**Files Modified**: `package.json`

### 3. Contentlayer Import Errors

**Issue**: Disabled files in app directory causing import errors
```
Module not found: Package path ./generated is not exported from package contentlayer2
```

**Solution**: Moved disabled files out of app directory
```bash
mkdir -p disabled-files
mv app/*.disabled disabled-files/
```

**Files Moved**: 
- `app/[slug].disabled/` → `disabled-files/[slug].disabled/`
- `app/blog/[slug].disabled/` → `disabled-files/blog/[slug].disabled/`
- `app/work/[slug].disabled/` → `disabled-files/work/[slug].disabled/`
- `app/sitemap.ts.disabled` → `disabled-files/sitemap.ts.disabled`

### 4. Package Manager Inconsistency

**Issue**: Vercel using npm while project uses pnpm
```
Detected `pnpm-lock.yaml` which may be generated by pnpm@9.x or pnpm@10.x
```

**Solution**: Updated Vercel configuration to use pnpm
```json
{
  "installCommand": "pnpm install",
  "buildCommand": "pnpm run build"
}
```

## ✅ Resolved Issues

### 1. WordPress Content Export - FULLY SUCCESSFUL

**Issue**: Export script appeared to have issues with posts and pages, but actually succeeded
- ✅ **Projects**: 5 case studies exported successfully
- ✅ **Posts**: 45 blog posts exported successfully  
- ✅ **Pages**: 27 static pages exported successfully

**Impact**: 77 out of 249 total pages migrated (31% completion)

**Resolution**: The WordPress REST API was fully functional and all content types were successfully exported. The 404 errors shown in the console were misleading - the export actually completed successfully.

**Export Results**:
```bash
# Content successfully exported
Projects: 5
Pages: 27  
Posts: 45
Total: 77 content items
```

**Content Structure**:
- `/content/project/` - 5 case studies
- `/content/page/` - 27 static pages
- `/content/post/` - 45 blog articles

## ❌ Ongoing Critical Issues

### 1. Contentlayer Integration Disabled

**Issue**: Dynamic page generation disabled due to import path issues
- Sitemap generation disabled
- Dynamic routing for projects/posts/pages not functional
- SEO metadata generation limited

**Impact**: Static site only, no dynamic content routing for 77 exported content items

**Next Steps**:
1. Fix contentlayer2 import paths
2. Restore dynamic page generation
3. Re-enable sitemap generation
4. Implement proper content routing

## 🔧 Build Process Status

### Current Build Output
```
Route (app)                                 Size  First Load JS    
┌ ○ /                                    4.31 kB         123 kB
├ ○ /_not-found                            986 B         103 kB
├ ○ /design-system-demo                  1.88 kB         117 kB
├ ○ /robots.txt                            127 B         102 kB
└ ○ /services/marketing-strategy         3.23 kB         117 kB
+ First Load JS shared by all             102 kB
```

### Generated Static Pages
1. **Homepage** (`/`) - Design system showcase
2. **404 Page** (`/_not-found`) - Error handling
3. **Design System Demo** (`/design-system-demo`) - Component library
4. **Robots.txt** (`/robots.txt`) - SEO configuration
5. **Services Page** (`/services/marketing-strategy`) - Static content

### Missing Dynamic Pages
- Project case studies (5 available but not routed)
- Blog posts (45 available but not routed)
- Static pages (27 available but not routed)

## 📊 Content Migration Status

### Successfully Exported Content
```
content/
├── project/ (5 case studies)
│   ├── blackriver/index.mdx
│   ├── blackriver-ramps-xmas/index.mdx
│   ├── bluefort-security/index.mdx
│   ├── bluefort-security-strategy/index.mdx
│   └── wolf-the-worlds-online-festival/index.mdx
├── page/ (27 static pages)
│   ├── about-us/index.mdx
│   ├── contact/index.mdx
│   ├── services/index.mdx
│   └── ... (24 more pages)
└── post/ (45 blog articles)
    ├── agile-marketing-plan-how-to/index.mdx
    ├── content-marketing-strategy-2024/index.mdx
    └── ... (43 more posts)
```

### Content Quality
- ✅ Proper front-matter structure
- ✅ SEO metadata included
- ✅ Canonical URLs generated
- ✅ Hero fields mapped
- ✅ Content sanitized and converted to MDX

### Export Report Summary
```json
{
  "summary": {
    "total": 77,
    "success": 77,
    "errors": 0,
    "duration": 1935
  }
}
```

## 🚀 Deployment Configuration

### Vercel Settings
- **Framework**: Next.js (auto-detected)
- **Build Command**: `pnpm run build`
- **Install Command**: `pnpm install`
- **Output Directory**: `.next`
- **Node Version**: 18.x

### Security Headers
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

### Media Redirects
```json
{
  "redirects": [
    {
      "source": "/wp-content/uploads/(.*)",
      "destination": "/images/$1",
      "permanent": true
    }
  ]
}
```

## 🔍 Debugging Commands

### Test WordPress API
```bash
# Check API availability
curl -I "https://polything.co.uk/wp-json/wp/v2/"

# Test specific endpoints
curl -s "https://polything.co.uk/wp-json/wp/v2/posts?per_page=1" | jq '.[0].title'
curl -s "https://polything.co.uk/wp-json/wp/v2/pages?per_page=1" | jq '.[0].title'
curl -s "https://polything.co.uk/wp-json/wp/v2/project?per_page=1" | jq '.[0].title'
```

### Verify Build
```bash
# Local build test
pnpm install
pnpm run build

# Check build output
ls -la .next/static/
```

### Content Validation
```bash
# Check exported content
find content -name "*.mdx" -exec wc -l {} \;
head -20 content/project/blackriver/index.mdx
```

## 📋 Next Steps Priority

### High Priority
1. **Restore Contentlayer** - Fix import issues for dynamic page generation
2. **Implement Content Routing** - Enable access to all 77 exported content items
3. **Complete Content Migration** - Export remaining 172 pages and posts

### Medium Priority
4. **QA Testing** - Validate migrated content against original WordPress site
5. **Performance Optimization** - Optimize build times and bundle sizes
6. **SEO Enhancement** - Implement full structured data and sitemap generation

### Low Priority
7. **Analytics Integration** - Add Google Analytics and performance monitoring
8. **Error Handling** - Implement comprehensive error boundaries and logging
9. **Documentation** - Create user guides and maintenance documentation

## 📞 Support Resources

### Documentation
- [WordPress REST API Reference](https://developer.wordpress.org/rest-api/reference/)
- [Contentlayer Documentation](https://www.contentlayer.dev/docs/)
- [Next.js App Router Guide](https://nextjs.org/docs/app)
- [Vercel Deployment Guide](https://vercel.com/docs/deployments/overview)

### Project Files
- `scripts/wp-export.mjs` - Main export script
- `config/wordpress.json` - WordPress API configuration
- `vercel.json` - Deployment configuration
- `contentlayer.config.ts` - Content processing configuration

---

**Last Updated**: 2025-01-27  
**Status**: Staging deployment successful, content export fully working (77/249 pages)  
**Next Review**: After contentlayer integration restoration
